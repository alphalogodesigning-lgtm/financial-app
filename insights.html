<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insights - The Therapy Session</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="./supabase-config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #E0E0E0;
            overflow-x: hidden;
        }

        .container {
            min-height: 100vh;
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .main-nav {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
            padding: 16px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }

        .nav-links {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .nav-link {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            color: #888;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
        }

        .nav-link:hover {
            border-color: #D4AF37;
            color: #D4AF37;
        }

        .nav-link.active {
            background: linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);
            color: #0a0a0a;
            border-color: #D4AF37;
        }

        .settings-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-btn:hover {
            border-color: #9C27B0;
            color: #9C27B0;
        }

        .header {
            margin-bottom: 32px;
            text-align: center;
        }

        .header-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 8px;
        }

        .header-subtitle {
            color: #888;
            font-size: 1.125rem;
        }

        .gold-text { color: #D4AF37; }
        .soft-blue-text { color: #89ABE3; }
        .green-text { color: #66BB6A; }
        .red-text { color: #FF6B6B; }
        .purple-text { color: #9C27B0; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 24px;
        }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 32px;
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 8px;
        }

        .modal-subtitle {
            color: #888;
            font-size: 0.95rem;
        }

        .roast-levels {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }

        .roast-level-option {
            padding: 20px;
            background: #0a0a0a;
            border: 2px solid #2a2a2a;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .roast-level-option:hover {
            border-color: #D4AF37;
            transform: translateY(-2px);
        }

        .roast-level-option.selected {
            border-color: #D4AF37;
            background: rgba(212, 175, 55, 0.1);
        }

        .roast-level-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .roast-level-emoji {
            font-size: 1.5rem;
        }

        .roast-level-name {
            font-size: 1.125rem;
            font-weight: 700;
            color: #fff;
        }

        .roast-level-description {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .roast-level-example {
            background: #1a1a1a;
            border-left: 3px solid #D4AF37;
            padding: 12px;
            font-size: 0.85rem;
            color: #aaa;
            font-style: italic;
            border-radius: 4px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.95rem;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid #2a2a2a;
            color: #888;
        }

        .btn-secondary:hover {
            border-color: #D4AF37;
            color: #D4AF37;
        }

        .btn-primary {
            background: linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);
            color: #0a0a0a;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        /* Current roast level indicator */
        .current-roast-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid #D4AF37;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #D4AF37;
            margin-left: auto;
        }

        /* Health Score */
        .health-score-container {
            text-align: center;
            margin-bottom: 48px;
        }

        .health-score-ring {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 24px;
        }

        .health-grade {
            font-size: 5rem;
            font-weight: 900;
            text-align: center;
            margin-bottom: 12px;
        }

        .health-score-label {
            font-size: 1.125rem;
            color: #888;
            font-weight: 600;
        }

        /* Brutal Honesty Box */
        .brutal-box {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.15) 0%, rgba(80, 0, 0, 0.15) 100%);
            border: 2px solid rgba(139, 0, 0, 0.4);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            position: relative;
            overflow: hidden;
        }

        .brutal-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #8B0000, #DC143C, #8B0000);
        }

        .brutal-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            font-size: 1.25rem;
            font-weight: 700;
            color: #FF6B6B;
        }

        .brutal-text {
            font-size: 1.125rem;
            line-height: 1.6;
            color: #E0E0E0;
        }

        /* Personality */
        .personality-container {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.15) 0%, rgba(103, 58, 183, 0.15) 100%);
            border: 2px solid rgba(156, 39, 176, 0.4);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            text-align: center;
        }

        .personality-type {
            font-size: 2rem;
            font-weight: 800;
            color: #9C27B0;
            margin-bottom: 12px;
            text-transform: uppercase;
        }

        .personality-description {
            font-size: 1.125rem;
            color: #E0E0E0;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .personality-traits {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .trait {
            padding: 8px 16px;
            background: rgba(156, 39, 176, 0.2);
            border: 1px solid rgba(156, 39, 176, 0.5);
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #CE93D8;
        }

        /* Insights Grid */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .insight-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .insight-card:hover {
            border-color: #D4AF37;
            transform: translateY(-4px);
        }

        .insight-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .insight-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 12px;
        }

        .insight-description {
            font-size: 0.95rem;
            color: #888;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .insight-stat {
            font-size: 2rem;
            font-weight: 800;
            color: #D4AF37;
            margin-bottom: 12px;
        }

        .insight-recommendation {
            background: rgba(212, 175, 55, 0.1);
            border-left: 3px solid #D4AF37;
            padding: 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #D4AF37;
        }

        /* Category Addiction */
        .category-addiction {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            text-align: center;
        }

        .addiction-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 24px;
        }

        .addiction-category {
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: 16px;
        }

        .addiction-stats {
            font-size: 1.125rem;
            color: #888;
            margin-bottom: 12px;
        }

        .addiction-percentage {
            font-size: 4rem;
            font-weight: 900;
            color: #FF6B6B;
            margin-bottom: 12px;
        }

        .addiction-note {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 8px;
            padding: 16px;
            font-size: 0.95rem;
            color: #FF6B6B;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Regret Money */
        .regret-section {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            text-align: center;
        }

        .regret-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 24px;
        }

        .regret-amount {
            font-size: 4rem;
            font-weight: 900;
            color: #FF6B6B;
            margin-bottom: 16px;
        }

        .regret-description {
            font-size: 1.125rem;
            color: #888;
            margin-bottom: 16px;
        }

        .regret-advice {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 8px;
            padding: 16px;
            font-size: 0.95rem;
            color: #FF6B6B;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Merchant Loyalty */
        .merchant-loyalty {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
        }

        .loyalty-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 24px;
            text-align: center;
        }

        .merchant-info {
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }

        .merchant-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .merchant-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #D4AF37;
            margin-bottom: 8px;
        }

        .merchant-visits {
            font-size: 2.5rem;
            font-weight: 900;
            color: #66BB6A;
            margin-bottom: 16px;
        }

        .merchant-note {
            background: rgba(212, 175, 55, 0.1);
            border-left: 3px solid #D4AF37;
            padding: 12px;
            border-radius: 4px;
            font-size: 0.95rem;
            color: #D4AF37;
            text-align: left;
        }

        /* Savings Rate */
        .savings-section {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            text-align: center;
        }

        .savings-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 24px;
        }

        .savings-percentage {
            font-size: 4rem;
            font-weight: 900;
            margin-bottom: 16px;
        }

        .savings-description {
            font-size: 1.125rem;
            color: #888;
            margin-bottom: 16px;
        }

        .savings-recommendation {
            background: rgba(102, 187, 106, 0.1);
            border: 1px solid rgba(102, 187, 106, 0.3);
            border-radius: 8px;
            padding: 16px;
            font-size: 0.95rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Achievements */
        .achievements-section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 24px;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
        }

        .achievement {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .achievement.unlocked {
            border-color: #D4AF37;
            background: rgba(212, 175, 55, 0.05);
        }

        .achievement.locked {
            opacity: 0.3;
        }

        .achievement:hover {
            transform: translateY(-4px);
        }

        .achievement-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .achievement-name {
            font-size: 0.95rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
        }

        .achievement-description {
            font-size: 0.75rem;
            color: #888;
        }

        /* Fun Stats */
        .fun-stats-section {
            margin-bottom: 32px;
        }

        .fun-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .fun-stat {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }

        .fun-stat-value {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 8px;
        }

        .fun-stat-label {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @media (max-width: 768px) {
            .insights-grid {
                grid-template-columns: 1fr;
            }

            .header-title {
                font-size: 2rem;
            }

            .modal-content {
                padding: 24px;
            }

            .nav-links {
                width: 100%;
            }

            .current-roast-indicator {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        (() => {
        if (window.__insightsInit) return;
        window.__insightsInit = true;
        const { useState, useEffect } = React;

        // Supabase setup
        const { supabaseClient, STORAGE_TABLE, waitForAuthSession } = window.SUPABASE_CONFIG;

        const resolveAuthSession = async () => {
            if (!supabaseClient) return null;
            const { data, error } = await supabaseClient.auth.getSession();
            if (error) throw error;
            if (data?.session) return data.session;
            const refreshed = await supabaseClient.auth.refreshSession();
            if (refreshed?.data?.session) return refreshed.data.session;
            return waitForAuthSession();
        };

        const getAuthenticatedUser = async () => {
            if (!supabaseClient) return null;
            const session = await resolveAuthSession();
            return session?.user || null;
        };

        const loadBudgetData = async () => {
            const fallback = localStorage.getItem('budgetTrackerData');
            if (!supabaseClient) {
                return fallback ? JSON.parse(fallback) : null;
            }
            try {
                const user = await getAuthenticatedUser();
                if (!user) {
                    window.location.href = 'auth.html';
                    return fallback ? JSON.parse(fallback) : null;
                }
                const { data, error } = await supabaseClient
                    .from(STORAGE_TABLE)
                    .select('data')
                    .eq('user_id', user.id)
                    .maybeSingle();
                if (error) throw error;
                if (data?.data) {
                    localStorage.setItem('budgetTrackerData', JSON.stringify(data.data));
                    return data.data;
                }
            } catch (err) {
                console.warn('Supabase load failed, using local data.', err);
            }
            return fallback ? JSON.parse(fallback) : null;
        };

        const saveBudgetData = async (budgetData) => {
            localStorage.setItem('budgetTrackerData', JSON.stringify(budgetData));
            if (!supabaseClient) return;
            try {
                const user = await getAuthenticatedUser();
                if (!user) return;
                await supabaseClient
                    .from(STORAGE_TABLE)
                    .upsert({
                        user_id: user.id,
                        data: budgetData,
                        updated_at: new Date().toISOString()
                    });
            } catch (err) {
                console.warn('Supabase save failed.', err);
            }
        };

        // Roast level configurations
        const ROAST_LEVELS = {
            gentle: {
                id: 'gentle',
                name: 'Gentle Nudge',
                emoji: 'üòä',
                description: 'Supportive and encouraging. I\'ll be nice about your financial decisions.',
                example: 'You\'re doing your best! Maybe we can find some small areas to improve together?',
                color: '#66BB6A'
            },
            honest: {
                id: 'honest',
                name: 'Honest Friend',
                emoji: 'üòê',
                description: 'Straight talk without sugar coating. The default balanced approach.',
                example: 'You\'re spending more than you earn. Time for a reality check.',
                color: '#89ABE3'
            },
            harsh: {
                id: 'harsh',
                name: 'Disappointed Parent',
                emoji: 'üò§',
                description: 'No holds barred. I\'ll tell you exactly what you need to hear.',
                example: 'This is embarrassing. You\'re literally burning money and wondering why you\'re broke.',
                color: '#FF6B6B'
            },
            brutal: {
                id: 'brutal',
                name: 'Drill Sergeant',
                emoji: 'üî•',
                description: 'Maximum intensity. Only for those who can handle the absolute truth.',
                example: 'WHAT ARE YOU DOING?! Your financial decisions are a disaster. This is pathetic.',
                color: '#DC143C'
            }
        };

        const INITIAL_DATA = {
            income: 0,
            fixedExpenses: [],
            variableExpenses: [],
            streak: 0,
            roast_level: 'honest'
        };

        function App() {
            const [data, setData] = useState(INITIAL_DATA);
            const [isHydrated, setIsHydrated] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [roastLevel, setRoastLevel] = useState('honest');
            const [tempRoastLevel, setTempRoastLevel] = useState('honest');

            useEffect(() => {
                let isMounted = true;
                loadBudgetData().then((saved) => {
                    if (!isMounted) return;
                    if (saved) {
                        setData(saved);
                        const savedRoastLevel = saved.roast_level || 'honest';
                        setRoastLevel(savedRoastLevel);
                        setTempRoastLevel(savedRoastLevel);
                    }
                    setIsHydrated(true);
                });
                return () => {
                    isMounted = false;
                };
            }, []);

            const handleSaveRoastLevel = async () => {
                const updatedData = {
                    ...data,
                    roast_level: tempRoastLevel
                };
                setData(updatedData);
                setRoastLevel(tempRoastLevel);
                setShowSettings(false);
                await saveBudgetData(updatedData);
            };

            // Calculate metrics
            const income = data.income;
            const totalFixedExpenses = data.fixedExpenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
            const totalVariableSpent = data.variableExpenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
            const totalSpent = totalFixedExpenses + totalVariableSpent;
            const savingsAmount = income - totalSpent;
            const savingsRate = income > 0 ? (savingsAmount / income) * 100 : 0;

            // Regret money
            const regretExpenses = data.variableExpenses.filter(exp => exp.is_regret || exp.regret);
            const regretMoney = regretExpenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
            const regretRatio = totalVariableSpent > 0 ? regretMoney / totalVariableSpent : 0;

            // Weekend vs Weekday
            const weekendExpenses = data.variableExpenses.filter(exp => {
                const day = new Date(exp.date).getDay();
                return day === 0 || day === 6;
            });
            const weekdayExpenses = data.variableExpenses.filter(exp => {
                const day = new Date(exp.date).getDay();
                return day !== 0 && day !== 6;
            });
            const avgWeekendSpend = weekendExpenses.length > 0 
                ? weekendExpenses.reduce((sum, exp) => sum + exp.amount, 0) / weekendExpenses.length 
                : 0;
            const avgWeekdaySpend = weekdayExpenses.length > 0 
                ? weekdayExpenses.reduce((sum, exp) => sum + exp.amount, 0) / weekdayExpenses.length 
                : 0;
            const weekendWeekdayRatio = avgWeekdaySpend > 0 ? avgWeekendSpend / avgWeekdaySpend : 0;

            // Late night spending
            const lateNightExpenses = data.variableExpenses.filter(exp => {
                const hour = new Date(exp.created_at).getHours();
                return hour >= 22 || hour < 4;
            });
            const lateNightSpent = lateNightExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const lateNightSpendRatio = totalVariableSpent > 0 ? lateNightSpent / totalVariableSpent : 0;

            // Top category
            const categoryTotals = {};
            data.variableExpenses.forEach(exp => {
                const cat = exp.category || 'Other';
                categoryTotals[cat] = (categoryTotals[cat] || 0) + exp.amount;
            });
            const topCategory = Object.keys(categoryTotals).reduce((a, b) => 
                categoryTotals[a] > categoryTotals[b] ? a : b, 'Food');
            const topCategoryAmount = categoryTotals[topCategory] || 0;
            const topCategoryPercentage = totalVariableSpent > 0 ? (topCategoryAmount / totalVariableSpent) * 100 : 0;

            // Top merchant
            const merchantVisits = {};
            data.variableExpenses.forEach(exp => {
                const merchant = exp.merchant || 'Unknown';
                merchantVisits[merchant] = (merchantVisits[merchant] || 0) + 1;
            });
            const topMerchant = Object.keys(merchantVisits).reduce((a, b) => 
                merchantVisits[a] > merchantVisits[b] ? a : b, '7-Eleven');
            const topMerchantVisits = merchantVisits[topMerchant] || 0;

            // Health Score calculation
            const calculateHealthScore = () => {
                let score = 50; // Start at 50

                // Savings rate (max +30, min -30)
                if (savingsRate >= 30) score += 30;
                else if (savingsRate >= 20) score += 25;
                else if (savingsRate >= 10) score += 15;
                else if (savingsRate >= 5) score += 5;
                else if (savingsRate >= 0) score -= 5;
                else if (savingsRate < 0) score -= 30; // Spending more than earning

                // Regret ratio penalties
                if (regretRatio <= 0.1) score += 15;
                else if (regretRatio < 0.4) score += 0;
                else if (regretRatio < 0.5) score -= 30;
                else if (regretRatio < 0.6) score -= 40;
                else if (regretRatio < 0.7) score -= 50;
                else if (regretRatio < 0.8) score -= 60;
                else score -= 70;

                // Late night spending (max +15, min -20)
                if (lateNightSpendRatio === 0) score += 15;
                else if (lateNightSpendRatio < 0.1) score += 10;
                else if (lateNightSpendRatio < 0.2) score += 3;
                else if (lateNightSpendRatio < 0.3) score -= 5;
                else if (lateNightSpendRatio < 0.4) score -= 15;
                else score -= 20; // 40%+ late night spending

                // Weekend spending (max +15, min -20)
                if (weekendWeekdayRatio < 1.2) score += 15;
                else if (weekendWeekdayRatio < 1.5) score += 8;
                else if (weekendWeekdayRatio < 2) score -= 5;
                else if (weekendWeekdayRatio < 3) score -= 10;
                else score -= 20; // 3x+ weekend spending

                // Streak bonus (max +20)
                if (data.streak >= 30) score += 20;
                else if (data.streak >= 14) score += 15;
                else if (data.streak >= 7) score += 10;

                return Math.max(0, Math.min(100, score));
            };

            const healthScore = calculateHealthScore();

            const getGradeInfo = (score) => {
                if (score >= 90) return { grade: 'A', text: 'EXCELLENT', color: '#66BB6A' };
                if (score >= 80) return { grade: 'B', text: 'GOOD', color: '#89ABE3' };
                if (score >= 70) return { grade: 'C', text: 'ROOM FOR IMPROVEMENT', color: '#D4AF37' };
                if (score >= 60) return { grade: 'D', text: 'NEEDS WORK', color: '#FF9800' };
                return { grade: 'F', text: 'CRITICAL', color: '#FF6B6B' };
            };

            const gradeInfo = getGradeInfo(healthScore);

            // Brutal truth messages based on roast level
            const getBrutalTruth = () => {
                const messages = {
                    gentle: {
                        extremeRegret: `You've marked ${(regretRatio * 100).toFixed(0)}% of your purchases as regrets. That's really high - maybe we should talk about what's happening?`,
                        overspending: "It looks like you're spending a bit more than you're earning. Let's work together to find a balance!",
                        highRegret: `You've had some regrets about RM${regretMoney.toFixed(0)} worth of purchases. Maybe take a moment before buying next time?`,
                        lowSavings: "Your savings could use a little boost. Even small changes can make a big difference over time!",
                        weekendSpending: `Your weekends are a bit pricier than weekdays. Maybe try some free activities on the weekend?`,
                        lateNight: "Looks like you shop late at night. Maybe sleep on it before making purchases after 10pm?",
                        good: "You're doing really well! Keep up the great work with your finances!"
                    },
                    honest: {
                        extremeRegret: `${(regretRatio * 100).toFixed(0)}% regret ratio. That means you regret 4 out of 5 purchases. This is a serious problem that needs addressing NOW.`,
                        overspending: "You're spending more than you earn. That's literally the definition of financial chaos. Time for a reality check.",
                        highRegret: `You regret RM${regretMoney.toFixed(0)} worth of purchases. That's ${(regretRatio * 100).toFixed(0)}% of your spending. Maybe pause before clicking 'Buy'?`,
                        lowSavings: "You're saving less than 5% of your income. At this rate, any emergency will destroy you. Not trying to be mean, just honest.",
                        weekendSpending: `Your weekend spending is ${weekendWeekdayRatio.toFixed(1)}x your weekday spending. Your wallet needs a vacation FROM the weekend.`,
                        lateNight: "You spend 30% of your money after 10pm. Put your phone down and go to sleep. Your wallet will thank you.",
                        good: "Actually... you're doing pretty well. Keep it up and you might actually achieve financial freedom. Crazy, right?"
                    },
                    harsh: {
                        extremeRegret: `${(regretRatio * 100).toFixed(0)}% REGRET RATIO?! You literally regret most of what you buy! Do you have ANY self-control? This is beyond pathetic.`,
                        overspending: "You're spending MORE than you earn? Really? This isn't sustainable. Your future self is going to hate you for this.",
                        highRegret: `RM${regretMoney.toFixed(0)} in regret purchases. That's ${(regretRatio * 100).toFixed(0)}% of your money wasted. Do you even think before buying?`,
                        lowSavings: "Less than 5% savings? You're one emergency away from financial ruin. This is embarrassing.",
                        weekendSpending: `${weekendWeekdayRatio.toFixed(1)}x more on weekends? You treat weekends like a license to throw money away. Grow up.`,
                        lateNight: "30% of your money vanishes after 10pm. Delete those shopping apps from your phone. This is pathetic.",
                        good: "Surprisingly, you're not completely hopeless. Don't let it go to your head though."
                    },
                    brutal: {
                        extremeRegret: `${(regretRatio * 100).toFixed(0)}% REGRET?! ARE YOU SERIOUS?! You regret ALMOST EVERYTHING you buy! What the hell is wrong with you?! STOP BUYING THINGS!`,
                        overspending: "YOU'RE SPENDING MORE THAN YOU MAKE. What part of 'budget' don't you understand?! This is financial suicide!",
                        highRegret: `RM${regretMoney.toFixed(0)} WASTED on regret purchases! That's ${(regretRatio * 100).toFixed(0)}% of your spending! Are you trying to stay poor?!`,
                        lowSavings: "LESS THAN 5% SAVINGS?! You're basically financially illiterate. One emergency and you're DONE. This is absolutely pathetic!",
                        weekendSpending: `WEEKEND SPENDING IS ${weekendWeekdayRatio.toFixed(1)}X HIGHER?! You're hemorrhaging money like it means nothing! STOP IT!`,
                        lateNight: "30% SPENT AFTER 10PM?! What are you doing?! Put down the phone, GO TO BED, and stop destroying your finances!",
                        good: "You're actually not terrible. Don't screw it up now. Stay disciplined or you'll end up like everyone else - broke."
                    }
                };

                const levelMessages = messages[roastLevel];

                // Check extreme regret FIRST (70%+)
                if (regretRatio >= 0.7) return levelMessages.extremeRegret;
                // Then check overspending
                if (totalSpent > income) return levelMessages.overspending;
                // Then high regret (40%+)
                if (regretRatio >= 0.4) return levelMessages.highRegret;
                // Then low savings
                if (savingsRate < 5) return levelMessages.lowSavings;
                // Then weekend spending
                if (weekendWeekdayRatio > 3) return levelMessages.weekendSpending;
                // Then late night spending
                if (lateNightSpendRatio > 0.3) return levelMessages.lateNight;
                // Otherwise, they're doing okay
                return levelMessages.good;
            };

            // Spending personality
            const getPersonality = () => {
                if (regretRatio > 0.4 && lateNightSpendRatio > 0.3) {
                    return {
                        type: 'THE IMPULSE BUYER',
                        description: 'Night shopping is becoming expensive. Save items at night, decide in daylight.',
                        traits: ['üé≠ Spontaneous', '‚ö° Regret-Prone', 'üéØ YOLO Spender']
                    };
                }
                if (savingsRate >= 20) {
                    return {
                        type: 'THE DISCIPLINED SAVER',
                        description: 'You\'re crushing it! Your future self will thank you.',
                        traits: ['üíé Disciplined', 'üéØ Goal-Oriented', 'üìä Data-Driven']
                    };
                }
                if (weekendWeekdayRatio > 3) {
                    return {
                        type: 'THE WEEKEND WARRIOR',
                        description: 'Weekends drain your wallet. Try free weekend activities.',
                        traits: ['üéâ Social Spender', 'üìÖ Weekend Splurger', 'üí∏ FOMO Driven']
                    };
                }
                return {
                    type: 'THE BALANCED BUDGETER',
                    description: 'You\'re finding your rhythm. Keep tracking and adjusting.',
                    traits: ['‚öñÔ∏è Balanced', 'üìà Improving', 'üéØ Aware']
                };
            };

            const personality = getPersonality();

            // Achievements
            const achievements = [
                { icon: 'üî•', name: '7-Day Streak', description: 'Tracked for 7 days', unlocked: data.streak >= 7 },
                { icon: 'üìÖ', name: 'Month Master', description: 'Tracked for 30 days', unlocked: data.streak >= 30 },
                { icon: 'üíé', name: 'Super Saver', description: 'Save 30% of income', unlocked: savingsRate >= 30 },
                { icon: 'üéØ', name: 'Conscious Spender', description: '<10% regret purchases', unlocked: regretRatio < 0.1 },
                { icon: 'üëë', name: 'Budget King', description: 'Stay under budget', unlocked: totalSpent <= income },
                { icon: 'üì±', name: 'Organized AF', description: '10+ expenses logged', unlocked: data.variableExpenses.length >= 10 },
            ];

            // Transaction stats
            const totalTransactions = data.variableExpenses.length;
            const avgTransactionSize = totalTransactions > 0 ? totalVariableSpent / totalTransactions : 0;
            const uniqueMerchants = new Set(data.variableExpenses.map(exp => exp.merchant)).size;
            const biggestPurchase = Math.max(...data.variableExpenses.map(exp => exp.amount || 0), 0);
            const annualSpendingRate = totalVariableSpent * 12;

            return (
                <div className="container">
                    <nav className="main-nav">
                        <div className="nav-links">
                            <a href="index.html" className="nav-link">üìä Dashboard</a>
                            <a href="fixed-expenses.html" className="nav-link">‚öì Fixed Expenses</a>
                            <a href="variable-spending.html" className="nav-link">üí∏ Variable Spending</a>
                            <a href="projections.html" className="nav-link">üîÆ Projections</a>
                            <a href="insights.html" className="nav-link active">üß† Insights</a>
                        </div>
                        <div className="current-roast-indicator">
                            <span>{ROAST_LEVELS[roastLevel].emoji}</span>
                            <span>{ROAST_LEVELS[roastLevel].name}</span>
                        </div>
                        <button className="settings-btn" onClick={() => setShowSettings(true)}>
                            <span>‚öôÔ∏è</span>
                            <span>Roast Level</span>
                        </button>
                    </nav>

                    <div className="header">
                        <h1 className="header-title">The Therapy Session</h1>
                        <p className="header-subtitle">Let's talk about your spending habits... honestly.</p>
                    </div>

                    {/* Financial Health Score */}
                    <div className="health-score-container">
                        <div className="health-grade" style={{ color: gradeInfo.color }}>
                            {gradeInfo.grade}
                        </div>
                        <div className="health-score-label">{gradeInfo.text}</div>
                        <div style={{ fontSize: '1.25rem', color: '#888', marginTop: '12px' }}>
                            Financial Health Score: <span style={{ color: gradeInfo.color, fontWeight: '700' }}>{healthScore}/100</span>
                        </div>
                    </div>

                    {/* Brutal Honesty */}
                    <div className="brutal-box">
                        <div className="brutal-title">
                            <span>üíÄ</span>
                            <span>Brutal Honesty Corner</span>
                        </div>
                        <div className="brutal-text">
                            {getBrutalTruth()}
                        </div>
                    </div>

                    {/* Spending Personality */}
                    <div className="personality-container">
                        <div className="personality-type">{personality.type}</div>
                        <div className="personality-description">{personality.description}</div>
                        <div className="personality-traits">
                            {personality.traits.map((trait, i) => (
                                <div key={i} className="trait">{trait}</div>
                            ))}
                        </div>
                    </div>

                    {/* Key Insights */}
                    <div className="insights-grid">
                        <div className="insight-card">
                            <div className="insight-icon">üìÖ</div>
                            <div className="insight-title">Weekend vs Weekday</div>
                            <div className="insight-description">
                                You spend an average of <strong style={{ color: '#D4AF37' }}>RM{avgWeekendSpend.toFixed(2)}</strong> per day on weekends
                                vs <strong style={{ color: '#89ABE3' }}>RM{avgWeekdaySpend.toFixed(2)}</strong> on weekdays.
                            </div>
                            <div className="insight-stat">
                                {Number.isFinite(weekendWeekdayRatio) ? `${weekendWeekdayRatio.toFixed(1)}x` : 'N/A'}
                            </div>
                            {weekendWeekdayRatio > 2 && (
                                <div className="insight-recommendation">
                                    üí° Your weekends are expensive. Maybe try a free hobby?
                                </div>
                            )}
                        </div>

                        <div className="insight-card">
                            <div className="insight-icon">üåô</div>
                            <div className="insight-title">Night Owl Analysis</div>
                            <div className="insight-description">
                                You've spent <strong style={{ color: '#FF6B6B' }}>RM{lateNightSpent.toFixed(2)}</strong> between 10pm and 4am.
                                That's <strong>{(lateNightSpendRatio * 100).toFixed(0)}%</strong> of your variable spending.
                            </div>
                            <div className="insight-stat" style={{ color: '#FF6B6B' }}>
                                {(lateNightSpendRatio * 100).toFixed(0)}%
                            </div>
                            {lateNightSpendRatio > 0.3 && (
                                <div className="insight-recommendation" style={{ borderColor: '#FF6B6B', color: '#FF6B6B' }}>
                                    üí° Nothing good happens to your wallet after 10pm. Delete those shopping apps from your home screen.
                                </div>
                            )}
                        </div>

                        <div className="insight-card">
                            <div className="insight-icon">üçî</div>
                            <div className="insight-title">Category Addiction</div>
                            <div className="insight-description">
                                Your top category is <strong style={{ color: '#D4AF37' }}>{topCategory}</strong> at 
                                <strong> RM{topCategoryAmount.toFixed(2)}</strong>. That's 
                                <strong> {topCategoryPercentage.toFixed(0)}%</strong> of your variable spending.
                            </div>
                            <div className="insight-stat">
                                {topCategoryPercentage.toFixed(0)}%
                            </div>
                            {topCategoryPercentage > 60 && (
                                <div className="insight-recommendation">
                                    üí° {topCategory === 'Food' ? 'You might have a Food problem. Or is it a passion? You decide.' : `${topCategoryPercentage.toFixed(0)}% on ${topCategory}? That's a lot.`}
                                </div>
                            )}
                        </div>

                        <div className="insight-card">
                            <div className="insight-icon">üò¨</div>
                            <div className="insight-title">Regret Money</div>
                            <div className="insight-description">
                                You've marked <strong style={{ color: '#FF6B6B' }}>RM{regretMoney.toFixed(2)}</strong> worth of purchases as regrets.
                                That's money you wish you could take back.
                            </div>
                            <div className="insight-stat" style={{ color: '#FF6B6B' }}>
                                RM{regretMoney.toFixed(2)}
                            </div>
                            {regretMoney > 50 && (
                                <div className="insight-recommendation" style={{ borderColor: '#FF6B6B', color: '#FF6B6B' }}>
                                    üí° Imagine if you had that RM{regretMoney.toFixed(0)} back. Wait 24hrs before big purchases.
                                </div>
                            )}
                        </div>

                        <div className="insight-card">
                            <div className="insight-icon">üè™</div>
                            <div className="insight-title">Merchant Loyalty</div>
                            <div className="insight-description">
                                Your most visited merchant is <strong style={{ color: '#D4AF37' }}>{topMerchant}</strong> 
                                with <strong>{topMerchantVisits}</strong> visits.
                            </div>
                            <div className="insight-stat" style={{ color: '#66BB6A' }}>
                                {topMerchantVisits}
                            </div>
                            {topMerchantVisits >= 7 && (
                                <div className="insight-recommendation">
                                    üí° {topMerchantVisits} visits to {topMerchant}. They should give you a loyalty card at this point.
                                </div>
                            )}
                        </div>

                        <div className="insight-card">
                            <div className="insight-icon">üí∞</div>
                            <div className="insight-title">Savings Rate</div>
                            <div className="insight-description">
                                You're saving <strong style={{ color: savingsRate >= 20 ? '#66BB6A' : '#FF6B6B' }}>
                                {savingsRate.toFixed(1)}%</strong> of your income. Financial experts recommend 20% minimum.
                            </div>
                            <div className="insight-stat" style={{ color: savingsRate >= 20 ? '#66BB6A' : '#FF6B6B' }}>
                                {savingsRate.toFixed(1)}%
                            </div>
                            <div className="insight-recommendation" style={{ 
                                borderColor: savingsRate >= 20 ? '#66BB6A' : '#FF6B6B',
                                color: savingsRate >= 20 ? '#66BB6A' : '#FF6B6B'
                            }}>
                                {savingsRate >= 20 
                                    ? 'üí° Excellent! Keep this up and you\'ll be financially secure.' 
                                    : 'üí° Try to increase your savings rate. Future you will be grateful.'}
                            </div>
                        </div>
                    </div>

                    {/* Achievements */}
                    <div className="achievements-section">
                        <h2 className="section-title">Achievements Unlocked</h2>
                        <div className="achievements-grid">
                            {achievements.map((achievement, i) => (
                                <div key={i} className={`achievement ${achievement.unlocked ? 'unlocked' : 'locked'}`}>
                                    <div className="achievement-icon">{achievement.icon}</div>
                                    <div className="achievement-name">{achievement.name}</div>
                                    <div className="achievement-description">{achievement.description}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Fun Stats */}
                    <div className="fun-stats-section">
                        <h2 className="section-title">Weird Stats That Don't Matter But Are Fun</h2>
                        <div className="fun-stats-grid">
                            <div className="fun-stat">
                                <div className="fun-stat-value gold-text">{totalTransactions}</div>
                                <div className="fun-stat-label">Transactions This Month</div>
                            </div>
                            <div className="fun-stat">
                                <div className="fun-stat-value soft-blue-text">RM{avgTransactionSize.toFixed(2)}</div>
                                <div className="fun-stat-label">Avg Transaction Size</div>
                            </div>
                            <div className="fun-stat">
                                <div className="fun-stat-value purple-text">{uniqueMerchants}</div>
                                <div className="fun-stat-label">Unique Merchants</div>
                            </div>
                            <div className="fun-stat">
                                <div className="fun-stat-value green-text">{data.streak}</div>
                                <div className="fun-stat-label">Day Streak</div>
                            </div>
                            <div className="fun-stat">
                                <div className="fun-stat-value red-text">RM{annualSpendingRate.toFixed(2)}</div>
                                <div className="fun-stat-label">Annual Spending Rate</div>
                            </div>
                            <div className="fun-stat">
                                <div className="fun-stat-value gold-text">RM{biggestPurchase.toFixed(2)}</div>
                                <div className="fun-stat-label">Biggest Single Purchase</div>
                            </div>
                        </div>
                    </div>

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="modal-overlay" onClick={() => setShowSettings(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2 className="modal-title">Choose Your Roast Level</h2>
                                    <p className="modal-subtitle">
                                        How honest do you want this app to be about your spending habits?
                                    </p>
                                </div>

                                <div className="roast-levels">
                                    {Object.values(ROAST_LEVELS).map(level => (
                                        <div 
                                            key={level.id}
                                            className={`roast-level-option ${tempRoastLevel === level.id ? 'selected' : ''}`}
                                            onClick={() => setTempRoastLevel(level.id)}
                                        >
                                            <div className="roast-level-header">
                                                <span className="roast-level-emoji">{level.emoji}</span>
                                                <span className="roast-level-name" style={{ color: level.color }}>
                                                    {level.name}
                                                </span>
                                            </div>
                                            <div className="roast-level-description">{level.description}</div>
                                            <div className="roast-level-example">
                                                Example: "{level.example}"
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="modal-actions">
                                    <button className="btn btn-secondary" onClick={() => setShowSettings(false)}>
                                        Cancel
                                    </button>
                                    <button className="btn btn-primary" onClick={handleSaveRoastLevel}>
                                        Save Preference
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        })();
    </script>
</body>
</html>
